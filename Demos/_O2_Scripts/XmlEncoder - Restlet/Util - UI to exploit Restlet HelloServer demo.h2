//var topPanel 		= panel.clear().add_Panel();
var topPanel 		= "Util - UI to exploit Restlet HelloServer demo".popupWindow(1200,700).insert_LogViewer();
var targetUrl 		= "http://localhost.:8111/firstResource/itemsXml";
var exploitsFolder 	= "exploits";

Action sendPayload  = null;
Action saveFile 	= null;
Action loadFiles    = null;

var codeEditor 		= topPanel.add_SourceCodeViewer();
var exploits 		= codeEditor.insert_Left(200,"Exploits").add_TreeView();
var browser 		= codeEditor.insert_Below("Response").add_WebBrowser();
var toolStrip 		= codeEditor.insert_Above_ToolStrip();

toolStrip.add_Button("Send Payload", "btExecuteOnExternalEngine_Image".formImage(),()=> sendPayload()).add_Separator();
var fileLoaded  = toolStrip.add_Label("Exploit:").add_TextBox("").width(150);
toolStrip.add_Button("Save", "SaveFile".formImage(),()=> saveFile()).add_Separator();;
var textBox 	= toolStrip.add_Label("Target url:").add_TextBox("").width(200);
toolStrip.add_Button("REPL form"      , "text_x_script".formImage(), ()=> toolStrip.script_Me());
toolStrip.add_Button("Exploits Folder", "Folder_Open1".formImage(), ()=> exploitsFolder.startProcess());
toolStrip.add_Button("Reload exploits", "view_refresh".formImage(), ()=> loadFiles());

exploits.afterSelect<string>((file)=>{
										var fullPath = exploitsFolder.pathCombine(file);
										fileLoaded.set_Text(file);
										codeEditor.open(fullPath);
									 });	
	
sendPayload = ()=>{
						var url	 	= textBox.get_Text();
						var payload = codeEditor.get_Text();						
						
						"Sending payload to: {0}".info(url);
						browser.showMessage("Sending payload....");
						
						var httpClient = new HttpClient();
						httpClient.DefaultHeaders.ContentType = "application/x-java-serialized-object+xml";
						var response = httpClient.Put(url, HttpContent.Create(payload));
						var html = response.Content.ReadAsString();
						"Received response with {0} bytes".info(html.size());
						browser.set_Html(html);
						
				  };

loadFiles = ()=>  {
					   exploits.clear()
					   		   .add_Nodes(exploitsFolder.files("*.xml").fileNames());
				  };
saveFile  = ()=>  {
					 var targetFile = exploitsFolder.pathCombine(fileLoaded.get_Text());
					 "Saving current file to: {0}".info(targetFile);
					 codeEditor.get_Text().saveAs(targetFile);					 
					 loadFiles();
				  };

exploitsFolder = PublicDI.CurrentScriptFolder.notNull() ? PublicDI.CurrentScriptFolder.pathCombine(exploitsFolder)
														: PublicDI.config.CurrentExecutableDirectory.pathCombine(exploitsFolder);
				  
textBox.set_Text(targetUrl);
loadFiles();
exploits.selectFirst();
browser.open(targetUrl);

//using Microsoft.Http
//O2Ref:O2_Misc_Microsoft_MPL_Libs.dll